apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sazurev3limits
spec:
  crd:
    spec:
      names:
        kind: K8sAzureV3Limits
      validation:
        openAPIV3Schema:
          properties:
            exemptImages:
              description: "List of container images to be excluded from policy enforcement."
              type: array
              items:
                type: string
            excludedNamespaces:
              description: "List of namespaces to be excluded from policy enforcement."
              type: array
              items:
                type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sazurev3limits

        import data.lib.exempt_container.is_exempt

        # Check if namespace is excluded
        namespace_excluded(ns) {
          excluded := object.get(input.parameters, "excludedNamespaces", [])
          ns == excluded[_]
        }

        # Violation if the namespace is excluded
        violation[{"msg": msg}] {
          ns := input.review.object.metadata.namespace
          namespace_excluded(ns)
          msg := sprintf("Namespace <%v> is excluded from enforcement", [ns])
        }

        # Ensure all containers have a memory limit set
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container)
          not container.resources
          msg := sprintf("Container <%v> has no resource limits", [container.name])
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container)
          not container.resources.limits
          msg := sprintf("Container <%v> has no resource limits set", [container.name])
        }

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container)
          not container.resources.limits.memory
          msg := sprintf("Container <%v> has no memory limit set", [container.name])
        }

      libs:
        - |
          package lib.exempt_container

          is_exempt(container) {
              exempt_images := object.get(object.get(input, "parameters", {}), "exemptImages", [])
              img := container.image
              exemption := exempt_images[_]
              _matches_exemption(img, exemption)
          }

          _matches_exemption(img, exemption) {
              not endswith(exemption, "*")
              exemption == img
          }

          _matches_exemption(img, exemption) {
              endswith(exemption, "*")
              prefix := trim_suffix(exemption, "*")
              startswith(img, prefix)
          }